---
layout: post
title: Extracting raster values into polygon attributes using R
excerpt: "Getting or calculating the values from an underlying raster using stars and sf"
category: rstats
tags: 
  - rspatial
  - sf
  - GIS
  - ArcView
image: 
  feature: featureSig.jpg
published: false
---

This is an update to a previous Spanish-language [post](https://luisdva.github.io/R-para-tareas-espaciales/){:target="_blank"} for working with spatial raster and vector data in R, prompted by recent developments such as the [stars](https://cran.r-project.org/web/packages/stars/index.html){:target="_blank"} package, its integration with [sf](https://cran.r-project.org/web/packages/sf/index.html){:target="_blank"} and [raster](https://cran.r-project.org/web/packages/raster/index.html){:target="_blank"}, and a particularly useful wrapper in [nngeo](https://cran.r-project.org/web/packages/nngeo/index.html){:target="_blank"}. 

Extracting the underlying values from a raster is a fairly common task, so here is a workflow to calculate and extract values (mean, max, min, etc) from a raster file across the distribution of a few different primate species in Mexico and Central America (‚ÄúMesoamerica‚Äù), loaded from a .shp file into a simple feature collection. 

We use a single raster file with gridded values for the Human Footprint index (a compound measure of direct and indirect human pressures on the environment globally), calculated for 2009 by Venter et al. [(2016)](https://www.nature.com/articles/sdata201667){:target="_blank"}, and a multipolygon shapefile of mammalian distribution maps downloaded from the IUCN Red List [Spatial Data and Mapping Resources page](https://www.iucnredlist.org/resources/spatial-data-download){:target="_blank"} (free & open download for educational use but an account is needed). All the required packages can be installed from CRAN, so this example can be reproduced by everyone (willing to download these large amounts of data). 

These are the main steps in the process:

# Load raster and polygon data
First, `read_stars` can read the geotiff raster file into a `stars` object and `st_read()` to load the shapefile. Country boundaries can be loaded from `rnaturalearth`. All the polygons were projected into Mollweide +proj to match the raster. 

{% highlight r %}
{% endhighlight %}

# Mask and crop the raster layer
We only need raster data for our study region, so we can crop it using `st_crop()`.
{% highlight r %}
{% endhighlight %}

This is the cropped raster:
<figure>
    <a href="/images/ctreeDefault.png"><img src="/images/ctreeDefault.png"></a>
        <figcaption>default plotting</figcaption>
</figure>
<br><br>

# Subset the multipolygon feature collection

Immediately after loading the mammal range maps we used a simple `dplyr` operation to keep only the primates (our Order of interest), now we can spatially subset the data to keep only the polygons within our study area. Afterwards we group by species and summarize their geometries (this operation goes by many names in traditional GIS jargon, such as dissolve or aggregate). Because they overlap, we can make a faceted plot of the seven species present in the study area to see their ranges. 

<figure>
    <a href="/images/ctreeDefault.png"><img src="/images/ctreeDefault.png"></a>
        <figcaption>default plotting</figcaption>
</figure>
<br><br>

# Extract the underlying raster values for each feature in the polygon layer

The `nngeo::raster_extract()` function comes in handy to apply `raster::extract()` on `stars` objects. It‚Äôs used here inside `mutate` to add new variables with the extracted values for each species (its vectorized for each feature üòé).

{% highlight r %}
{% endhighlight %}

We can pull the data sans the geometry using `st_set_geometry(NULL)` and have a look at the extracted values. 

|binomial           |   hfpMean|   hfpMax|   hfpMin|
|:------------------|---------:|--------:|--------:|
|Alouatta palliata  |  9.087961| 50.00000| 0.000000|
|Alouatta pigra     |  5.716039| 47.00000| 0.000000|
|Aotus zonalis      |  7.390708| 42.41053| 1.000000|
|Ateles fusciceps   |  3.870575| 18.04213| 1.000000|
|Ateles geoffroyi   |  8.495973| 50.00000| 0.000000|
|Saguinus geoffroyi |  6.306356| 42.41053| 1.000000|
|Saimiri oerstedii  | 10.727800| 40.78853| 3.002395|


Lastly, we can plot everything together with `ggplot2`. This quick and simple map could be customized further with various grammar of graphics touches, but for now it looks pretty good. 

 <figure>
    <a href="/images/ctreeDefault.png"><img src="/images/ctreeDefault.png"></a>
        <figcaption>default plotting</figcaption>
</figure>
<br><br>
