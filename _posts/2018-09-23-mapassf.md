---
title: "Mapas nítidos con R, ggplot2 y sf"
layout: post
excerpt: Figuras espaciales con puntos y polígonos.
category: rstats
tags:
  - SIG
  - espacial
  - rspatial
  - sp
image: 
  feature: featureMapas.png
  credit: Lake Retba, Senegal. Photo by user aliunix on Unsplash.
  creditlink: 
published: false
---

Aquí comparto código y algunas recomendaciones para crear figuras espaciales de puntos y polígonos usando R y los paquetes _ggplot_ y _sf_. 

En este ejemplo, supongamos que queremos crear un mapa con división política y datos puntuales sobre observaciones para dos especies de animales. Sin necesidad de descargar Shapefiles o leer archivos externos, vamos a usar datos proporcionados por el paquete _rnaturalearth_ (una librería que almacena e interactúa con datos de Natural Earth, un conjunto flexible de capas espaciales de libre uso), y vamos a generar puntos aleatorios como si fueran registros puntuales para las dos especies de animales. 

Para esta demostración elegí Senegal. Podemos generar un objecto sf (simple features) para el continente africano, y filtrar este mismo usando nombres de países. Despueś, la función _st/_sample_ sirve para generar puntos aleatorios para dos especies hipotéticas dentro del polígono de Senegal. 
{% highlight r %}
{% endhighlight %}

Estos dos objetos ya se pueden dibujar con _ggplot_. El mapa no se ve mal, y aún no hemos cambiado los parámetros gráficos. 
{% highlight r %}
{% endhighlight %}
FIG

Si cambiamos el tamaño de los puntos y los hacemos más grandes, algunos van a quedar encimados y no se van a ver bien. Para resolver ésto, tomé las sugerencias de éste [tutorial](https://drsimonj.svbtle.com/pretty-scatter-plots-with-ggplot2) de Simon Jackson para que los puntos tengan transparencia según la densidad local (inversamente proporcional). Si hay muchos puntos juntos, les damos transparencia para que se vean, y los que están solos espacialmente se mantienen opacos. 

Para hacer ésto, primero obtenemos las coordenadas del objeto sf (están guardadas en una columna-lista) y calculamos la densidad espacial de los puntos con el paquete _pointdensityP_. Escogí un tamaño de gradilla chico, pero este parámetro se puede cambiar. Después unimos las densidades con el objeto sf y estandarizamos sus valores entre 0 y 1. 
{% highlight r %}
{% endhighlight %}

> **OJO**, que la función _pointdensity_ acomoda los resultados por densidad (de menor a mayor) y por eso hay que hacer una unión (join) para que no se pierda el orden original de los datos.  

Otra cosa que podemos hacer es darle más contexto geográfico a nuestro mapa. Para ésto, podemos dibujar los polígonos de los países aledaños a Senegal. La función _st/_touches_ nos dice cuáles polígonos (del objeto para todo el continente) comparten frontera con Senegal. De esta manera podemos asignar un nuevo objeto sf con estos polígonos vecinos a partir del objeto para todo África. 

{% highlight r %}
{% endhighlight %}

Finalmente, vamos a personalizar la forma, color, los bordes, y la transparencia de los puntos. Usamos _st/_bbox_ y _st/_buffer_ para acotar el mapa a Senegal usando los argumentos de límite dentro de _coord/_sf_, escondemos la gradilla, y agregamos títulos informativos. El resultado final se ve bastante nítido. 

{% highlight r %}
{% endhighlight %}

Para comparar los dos, esta secuencia de funciones usan la magia de purrr, fs, y magick para leer las imágenes que exportamos y animar una transición gradual entre las dos en formato .gif. 

{% highlight r %}
{% endhighlight %}
